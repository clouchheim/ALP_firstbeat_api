name: Firstbeat scheduled pipeline

on:
  schedule:
    - cron: "0 */6 * * *"  # every 6 hours
  workflow_dispatch:

jobs:
  firstbeat:
    runs-on: ubuntu-latest

    steps:
    # -------------------------
    # Checkout repo
    # -------------------------
    - name: Checkout repo
      uses: actions/checkout@v3

    # -------------------------
    # Set up Python
    # -------------------------
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install Python packages
      run: |
        python -m pip install --upgrade pip
        pip install requests python-dotenv tqdm pyjwt pandas

    # -------------------------
    # Set up R
    # -------------------------
    - name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        use-public-rspm: true

    # -------------------------
    # Cache R packages
    # -------------------------
    - name: Cache R packages
      uses: actions/cache@v3
      with:
        path: ${{ env.R_LIBS_USER }}
        key: ${{ runner.os }}-r-packages-${{ hashFiles('**/*.R') }}
        restore-keys: |
          ${{ runner.os }}-r-packages-

    # -------------------------
    # Install R packages
    # -------------------------
    - name: Install R packages
      run: |
        Rscript -e 'install.packages(c("dplyr","readr","smartabaseR"), repos="https://cloud.r-project.org")'

    # -------------------------
    # Run Firstbeat pipeline
    # -------------------------
    - name: Run Firstbeat Pipeline
      run: |
        chmod +x run_firstbeat.sh
        ./run_firstbeat.sh
