name: Firstbeat scheduled pipeline

on:
  schedule:
    - cron: "0 */6 * * *"  # every 6 hours
  workflow_dispatch:

jobs:
  firstbeat:
    runs-on: ubuntu-latest
    env:
      ID: ${{ secrets.ID }}
      SHARED_SECRET: ${{ secrets.SHARED_SECRET }}
      API_KEY: ${{ secrets.API_KEY }}
      SB_USERNAME: ${{ secrets.SB_USERNAME }}
      SB_PASSWORD: ${{ secrets.SB_PASSWORD }}
    steps:
    # -------------------------
    # Checkout repo
    # -------------------------
    - name: Checkout repo
      uses: actions/checkout@v3

    # -------------------------
    # Set up Python
    # -------------------------
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install Python packages
      run: |
        python -m pip install --upgrade pip
        pip install requests python-dotenv tqdm pyjwt pandas

    # -------------------------
    # Set up R
    # -------------------------
    - name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        use-public-rspm: true

    # -------------------------
    # Install R packages
    # -------------------------
    - name: Install R packages
      run: |
        Rscript -e 'dir.create(Sys.getenv("R_LIBS_USER"), recursive=TRUE, showWarnings=FALSE)'
        Rscript -e '.libPaths(Sys.getenv("R_LIBS_USER")); install.packages(c("dplyr","readr","devtools"), repos="https://cloud.r-project.org")'
        Rscript -e '.libPaths(Sys.getenv("R_LIBS_USER")); devtools::install_github("Teamworksapp/smartabaseR")'
    - name: Debug environment variables
      run: |
        echo "ID is set: ${ID:+YES}" 
        echo "SHARED_SECRET is set: ${SHARED_SECRET:+YES}"
        echo "API_KEY is set: ${API_KEY:+YES}"
        echo "SB_USERNAME is set: ${SB_USERNAME:+YES}"
        echo "SB_PASSWORD is set: ${SB_PASSWORD:+YES}"

    # -------------------------
    # Cache R packages
    # -------------------------
    - name: Cache R packages
      uses: actions/cache@v3
      with:
        path: ${{ env.R_LIBS_USER }}
        key: ${{ runner.os }}-r-packages-${{ hashFiles('**/*.R') }}
        restore-keys: |
          ${{ runner.os }}-r-packages-
        
    # -------------------------
    # Run Firstbeat pipeline
    # -------------------------
    - name: Run Firstbeat Pipeline
      run: |
        chmod +x run_firstbeat.sh
        ./run_firstbeat.sh
