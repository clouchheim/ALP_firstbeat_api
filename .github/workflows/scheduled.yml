name: Firstbeat scheduled pipeline

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  firstbeat:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      ID: ${{ secrets.ID }}
      SHARED_SECRET: ${{ secrets.SHARED_SECRET }}
      API_KEY: ${{ secrets.API_KEY }}
      SB_USERNAME: ${{ secrets.SB_USERNAME }}
      SB_PASSWORD: ${{ secrets.SB_PASSWORD }}

    steps:
    # -------------------------
    # Checkout repo
    # -------------------------
    - uses: actions/checkout@v3

    # -------------------------
    # Set up Python
    # -------------------------
    - uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install Python packages
      run: |
        python -m pip install --upgrade pip
        pip install requests python-dotenv tqdm pyjwt pandas

    # -------------------------
    # Set up R
    # -------------------------
    - uses: r-lib/actions/setup-r@v2
      with:
        use-public-rspm: true

    # -------------------------
    # Install system dependencies (needed for some R packages)
    # -------------------------
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libcurl4-openssl-dev \
          libssl-dev \
          libxml2-dev

    # -------------------------
    # Install R packages (NO devtools)
    # -------------------------
    - name: Install R packages
      run: |
        Rscript -e '
          install.packages(
            c("dplyr", "readr", "remotes"),
            repos = "https://cloud.r-project.org"
          )
          remotes::install_github("Teamworksapp/smartabaseR", ref = "main")
        '

    # -------------------------
    # Debug environment variables
    # -------------------------
    - name: Debug environment variables
      run: |
        echo "ID is set: ${ID:+YES}"
        echo "SHARED_SECRET is set: ${SHARED_SECRET:+YES}"
        echo "API_KEY is set: ${API_KEY:+YES}"
        echo "SB_USERNAME is set: ${SB_USERNAME:+YES}"
        echo "SB_PASSWORD is set: ${SB_PASSWORD:+YES}"

    # -------------------------
    # Run Firstbeat pipeline
    # -------------------------
    - name: Run Firstbeat Pipeline
      run: |
        chmod +x run_firstbeat.sh
        ./run_firstbeat.sh
